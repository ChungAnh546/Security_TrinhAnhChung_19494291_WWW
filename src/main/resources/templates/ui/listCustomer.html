<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:fragment="layout(content)">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>List Customer</title>

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet"
    th:href="@{https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback}">
  <!-- Font Awesome -->
  <link rel="stylesheet" th:href="@{https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css}"
    integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" th:href="@{/dist/css/popup_thong_bao.css}">
  <link rel="stylesheet" th:href="@{/plugins/toastr/toastr.min.css}">

  <!-- Theme style -->
  <link rel="stylesheet" th:href="@{/dist/css/adminlte.min.css}">
  <link rel="stylesheet" th:href="@{/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css}">
  <link rel="stylesheet" th:href="@{/plugins/datatables-responsive/css/responsive.bootstrap4.min.css}">
  <link rel="stylesheet" th:href="@{/plugins/datatables-buttons/css/buttons.bootstrap4.min.css}">

</head>

<body class="hold-transition sidebar-mini">
  <div class="wrapper">
    <!-- Navbar -->

    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
      <!-- Left navbar links -->

      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" data-widget="pushmenu" th:href="@{#}" role="button"><i class="fas fa-bars"></i></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-widget="fullscreen" th:href="@{#}" role="button">
            <i class="fas fa-expand-arrows-alt"></i>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-widget="control-sidebar" data-slide="true" th:href="@{#}" role="button">
            <i class="fas fa-th-large"></i>
          </a>
        </li>
      </ul>



      <!-- Right navbar links -->
      <ul class="navbar-nav ml-auto">
        <!-- Navbar Search -->


        <!-- Messages Dropdown Menu -->
        <!--  -->
        <!-- Notifications Dropdown Menu -->


      </ul>
      <div class="user-panel mr-2 d-flex">
        <div class="image">
          <img th:src="@{/public/tom.jpg}" id="accImage" width="50" height="50" class="img-circle elevation-2"
            alt="User Image">
        </div>
        <div class="info">
          <a th:href="@{#}" id="accName" class="d-block"></a>
        </div>
      </div>
    </nav>
    <!-- /.navbar -->

    <!-- Main Sidebar Container -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
      <!-- Brand Logo -->


      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Sidebar user (optional) -->




        <!-- Sidebar Menu -->
        <nav class="mt-2">
          <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
            <!-- Add icons to the links using the .nav-icon class
               with font-awesome or any other icon font library -->

            <li class="nav-item menu-open">
              <a th:href="@{#}" class="nav-link active">
                <i class="nav-icon fas fa-edit"></i>
                <p>
                  Manager
                  <i class="fas fa-angle-left right"></i>
                </p>
              </a>
              <ul class="nav nav-treeview">
                <li class="nav-item">
                  <a th:href="@{/employee/add}" class="nav-link ">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Add Employee</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a th:href="@{/employee/list}" class="nav-link ">
                    <i class="far fa-circle nav-icon"></i>
                    <p>List Employee</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a th:href="@{/customer/add}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Add Customer</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a th:href="@{/customer/list}" class="nav-link active">
                    <i class="far fa-circle nav-icon"></i>
                    <p>List Customer</p>
                  </a>
                </li>
              </ul>
            </li>


          </ul>
        </nav>
        <!-- /.sidebar-menu -->
      </div>
      <!-- /.sidebar -->
    </aside>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
      <!-- Content Header (Page header) -->


      <!-- Main content -->
      <section class="content">
        <div class="container-fluid">
          <div class="row">
            <!-- left column -->
            <div class="col-md-12">
              <!-- jquery validation -->
              <div class="card card-primary">
                <div class="card-header">
                  <h3 class="card-title">List Customer</h3>
                </div>
                <!-- /.card-header -->
                <!-- form start -->


                <div class="card-body " id="tableCustomer_wrapper">
                  <table id="tableCustomer" class="table table-bordered table-hover ">
                    <thead>
                      <tr>
                        <th>
                          Select
                        </th>
                        <th>STT</th>
                        <th hidden>Id</th>
                        <th>Name</th>

                        <th>Phone</th>
                        <th>Email</th>
                        <th>Address</th>
                        <th>Status</th>
                        <th>Take Note</th>
                        <th>Function</th>

                      </tr>
                    </thead>
                    <tbody>


                      <tr th:each="customer, i : ${cList}">
                        <td>
                          <div class="d-flex justify-content-center"><input type="checkbox" name="select" />
                          </div>
                        </td>
                        <td th:text="${i.index + 1}"></td>
                        <td th:text="${customer.id}" class="id" hidden></td>
                        <td th:text="${customer.customerName}" class="fullName"></td>

                        <td th:text="${customer.phone}" class="phone"></td>

                        <td>
                          <!-- <td th:text="${email1}"></td> -->
                          <div class="d-flex justify-content-center" th:each="email: ${customer.customerMails}">
                            <p th:text="${email.mail}"></p>
                            <button class="btn btnDeleteMail btn-danger ml-2 "
                              style="width: 25px; height: 25px;    padding-top: 0;    padding-left: 1.7%;">
                              <i class="fa-solid fa-minus" style="text-align: center;"></i></button>
                          </div>


                        </td>
                        <td th:text="${customer.address}" class="address"></td>
                        <td th:text="${customer.status}" class="status"></td>
                        <td th:text="${customer.takeNote}" class="takeNote"></td>
                        <td>
                          <div class="d-flex justify-content-center"><button class="btn btnUpdate btn-warning "
                              data-toggle="modal" data-target="#modal-update"><i
                                class="fa-regular fa-pen-to-square"></i></button>
                            <button class="btn btnAdd btn-success mr-2 ml-2"><i class="fa-regular fa-plus"></i></button>
                            <button class="btn btnDelete btn-danger ">
                              <i class="fa-solid fa-minus"></i></button>
                          </div>
                        </td>
                      </tr>

                    </tbody>
                    <tfoot>
                      <tr>
                        <th>
                          <div class="d-flex justify-content-center"><button class="btn btnDeleteAll btn-danger ">
                              <i class="fa-solid fa-minus"></i></button></div>
                        </th>
                        <th>STT</th>
                        <th hidden>Id</th>
                        <th>Name</th>

                        <th>Phone</th>
                        <th>Email</th>
                        <th>Address</th>
                        <th>Status</th>
                        <th>Take Note</th>

                        <th>Function</th>
                      </tr>
                    </tfoot>
                  </table>
                </div>

              </div>
              <!-- /.card -->
            </div>
            <!--/.col (left) -->
            <!-- right column -->
            <div class="col-md-6">

            </div>
            <!--/.col (right) -->
          </div>
          <!-- /.row -->
        </div><!-- /.container-fluid -->
        <div class="modal fade " id="modal-addEmail">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h4 class="modal-title">Add Email</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">


                <form id="formAddEmail">

                  <!-- input states -->



                  <div class="form-group ">
                    <label for="exampleSelectRounded0" class=" col-form-label">Name </label>
                    <div class=" ">
                      <select class=" form-control" id="addMailNameE">


                      </select>
                    </div>
                  </div>
                  <div class="form-group ">
                    <label for="inputAddEmail" class=" col-form-label">Email</label>
                    <div class="input">
                      <input type="email" name="emailAddEmail" class="form-control" id="inputAddEmail"
                        placeholder="Enter email">
                    </div>

                  </div>


                  <!-- <div class="form-group">
                        <label class="col-form-label" for="inputError"><i class="far fa-times-circle"></i> Input
                          with
                          error</label>
                        <input type="text" class="form-control is-invalid" id="inputError"
                          placeholder="Enter ...">
                      </div> -->

                  <!--  -->




                </form>

                <!-- /.card-body -->

                <!-- body modal -->

              </div>
              <div class="modal-footer justify-content-between">
                <button type="button" id="closeModalEmail" class="btn btn-default" data-dismiss="modal">Đóng</button>
                <button type="button" id="addEmail" class="btn btn-success"><i class="fa-regular fa-floppy-disk"></i>
                  Save</button>
              </div>
            </div>
            <!-- /.modal-content -->
          </div>
          <!-- /.modal-dialog -->
        </div>
        <div class="modal fade " id="modal-update">
          <div class="modal-dialog ">
            <div class="modal-content">
              <div class="modal-header">
                <h4 class="modal-title">Update Customer</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">


                <form id="formUpdateCustomer">

                  <!-- input states -->
                  <div class="form-group " style="position: relative;" hidden>
                    <label for="InputFullName" class=" col-form-label">Id</label>
                    <div class=" input">
                      <input type="text" name="fullName" class="form-control" id="inputId"
                        placeholder="Enter full name">
                    </div>

                  </div>
                  <div class="form-group " style="position: relative;">
                    <label for="InputFullName" class=" col-form-label">Customer name</label>
                    <div class=" input">
                      <input type="text" name="fullName" class="form-control" id="inputFullName"
                        placeholder="Enter full name">
                    </div>

                  </div>
                  <div class="form-group ">
                    <label for="InputPhone" class=" col-form-label">Phone</label>
                    <div class=" input">
                      <input type="number" name="phone" class="form-control" id="inputPhone" placeholder="Enter phone">
                    </div>

                  </div>


                  <div class="form-group ">
                    <label for="InputAddress" class=" col-form-label">Address</label>
                    <div class=" input">
                      <input type="text" name="address" class="form-control" id="inputAddress"
                        placeholder="Enter address">
                    </div>

                  </div>



                  <div class="form-group ">
                    <label for="exampleSelectRounded0" class=" col-form-label">Status </label>
                    <div class=" ">
                      <select class=" form-control" id="status">
                        <option value="Active">Active</option>
                        <option value="Deactive">Deactive</option>

                      </select>
                    </div>
                  </div>

                  <div class="form-group ">
                    <label for="inputTakeNote" class=" col-form-label">Take note</label>
                    <div class=" input">
                      <input type="text" name="takeNote" class="form-control" id="inputTakeNote"
                        placeholder="Enter address">

                    </div>

                  </div>


                  <!-- <div class="form-group">
                        <label class="col-form-label" for="inputError"><i class="far fa-times-circle"></i> Input
                          with
                          error</label>
                        <input type="text" class="form-control is-invalid" id="inputError"
                          placeholder="Enter ...">
                      </div> -->

                  <!--  -->




                </form>

                <!-- /.card-body -->

                <!-- body modal -->

              </div>
              <div class="modal-footer justify-content-between">
                <button type="button" id="closeModalUpdate" class="btn btn-default" data-dismiss="modal">Đóng</button>
                <button type="button" id="updateEmployee" class="btn btn-primary bg-warning"><i
                    class="fa-regular fa-pen-to-square"></i>Chỉnh sửa</button>
              </div>
            </div>
            <!-- /.modal-content -->
          </div>
          <!-- /.modal-dialog -->
        </div>
      </section>
      <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->


    <!-- Control Sidebar -->
    <aside class="control-sidebar control-sidebar-dark">
      <!-- Control sidebar content goes here -->
    </aside>
    <!-- /.control-sidebar -->
  </div>
  <!-- ./wrapper -->

  <!-- jQuery -->
  <script th:src="@{/plugins/jquery/jquery.min.js}"></script>
  <!-- Bootstrap 4 -->
  <script th:src="@{/plugins/bootstrap/js/bootstrap.bundle.min.js}"></script>
  <!-- jquery-validation -->
  <script th:src="@{/plugins/jquery-validation/jquery.validate.min.js}"></script>
  <script th:src="@{/plugins/jquery-validation/additional-methods.min.js}"></script>
  <!-- AdminLTE App -->
  <script th:src="@{/dist/js/adminlte.min.js}"></script>
  <script th:src="@{/plugins/toastr/toastr.min.js}"></script>
  <!-- AdminLTE for demo purposes -->
  <script th:src="@{https://cdn.jsdelivr.net/npm/sweetalert2@11}"></script>
  <script th:src="@{/dist/js/demo.js}"></script>
  <script th:src="@{/plugins/datatables-buttons/js/buttons.html5.min.js}"></script>
  <script th:src="@{/plugins/datatables-buttons/js/buttons.print.min.js}"></script>
  <script th:src="@{/plugins/datatables-buttons/js/buttons.colVis.min.js}"></script>
  <script th:src="@{/plugins/datatables/jquery.dataTables.min.js}"></script>
  <script th:src="@{/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js}"></script>
  <script th:src="@{/plugins/datatables-responsive/js/dataTables.responsive.min.js}"></script>
  <script th:src="@{/plugins/datatables-responsive/js/responsive.bootstrap4.min.js}"></script>
  <script th:src="@{/plugins/datatables-buttons/js/dataTables.buttons.min.js}"></script>
  <script th:src="@{/plugins/datatables-buttons/js/buttons.bootstrap4.min.js}"></script>

  <!-- Page specific script -->
  <script>

    $(function () {
      $("#tableCustomer").DataTable({
        "responsive": true, "lengthChange": false, "autoWidth": false,
        "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"]
      }).buttons().container().appendTo('#tableCustomer_wrapper .col-md-6:eq(0)');




    });
    async function getEmployeeByEmail(email) {
      var employee;
      try {
        employee = await $.ajax({
          type: "GET",
          url: "/employee/search/email?email=" + email,
          dataType: "json",
          success: function (response) {

          },
          error: function (jqXHR, textStatus, errorThrown) {
            return null
          }
        });
      } catch (error) {
        employee = null;
      }
      return employee;

    }
    async function getEmployeeByPhone(phone) {
      var employee;
      try {
        employee = await $.ajax({
          type: "GET",
          url: "/employee/search/phone?phone=" + phone,
          dataType: "json",
          success: function (response) {

          },
          error: function (jqXHR, textStatus, errorThrown) {
            return null
          }
        });
      } catch (error) {
        employee = null;
      }
      return employee;

    }
    async function duplicateCheck(email, phone, id) {
      var phoneCheck;
      var emailCheck;
      var phoneRegex = /^\d{10}$/;
      var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!phoneRegex.test(phone)) {
        var validator = $("#quickForm").validate();
        validator.showErrors({
          phone: "Phone already exists." // Thông báo lỗi trùng email
        });
        return false;
      }
      if (!emailRegex.test(email)) {
        var validator = $("#quickForm").validate();
        validator.showErrors({
          email: "Email already exists." // Thông báo lỗi trùng email
        });
        return false;
      }
      if (email) {
        emailCheck = await getEmployeeByEmailAndId(email, id);
        if (emailCheck) {
          var validator = $("#formUpdateCustomer").validate();
          validator.showErrors({
            email: "Email already exists." // Thông báo lỗi trùng email
          });
        }
      }
      if (phone) {
        phoneCheck = await getEmployeeByPhoneAndId(phone, id);



        if (phoneCheck) {
          var validator = $("#formUpdateCustomer").validate();
          validator.showErrors({
            phone: "Phone already exists." // Thông báo lỗi trùng email
          });
        }

      }



      if (emailCheck || phoneCheck) {
        return false;
      } else {
        return true;
      }

    }
    async function getEmployeeByEmailAndId(email, id) {
      var employee;
      try {
        employee = await $.ajax({
          type: "GET",
          url: "/employee/search/email-and-id?email=" + email + "&id=" + id,
          dataType: "json",
          success: function (response) {

          },
          error: function (jqXHR, textStatus, errorThrown) {
            return null
          }
        });
      } catch (error) {
        employee = null;
      }
      return employee;

    }
    async function getEmployeeByPhoneAndId(phone, id) {
      var employee;
      try {
        employee = await $.ajax({
          type: "GET",
          url: "/employee/search/phone-and-id?phone=" + phone + "&id=" + id,
          dataType: "json",
          success: function (response) {

          },
          error: function (jqXHR, textStatus, errorThrown) {
            return null
          }
        });
      } catch (error) {
        employee = null;
      }
      return employee;

    }
    async function deleteCustomerByPhone(phone) {
      var url = "/customer/delete?phone=" + phone;
      try {
        await $.ajax({
          url: url,
          type: "GET",
          contentType: "application/json",

        });
        return true;
      } catch (error) {
        return false;
      }

    }
    async function deleteCustomerByEmail(email) {
      var url = "/customer-mail/delete?email=" + email;
      try {
        await $.ajax({
          url: url,
          type: "GET",
          contentType: "application/json",

        });
        return true;
      } catch (error) {
        return false;
      }

    }
    $(".btnDeleteMail").click(function () {
      var valuePCard = $(this).prev("p").text();
      const swalWithBootstrapButtons = Swal.mixin({
        customClass: {
          confirmButton: 'btn btn-success',
          cancelButton: 'btn btn-danger mr-4'
        },
        buttonsStyling: false
      })
      swalWithBootstrapButtons.fire({
        title: 'Are you sure?',
        text: "Are you sure you want to delete!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'delete',
        cancelButtonText: 'cancel',
        reverseButtons: true
      }).then(async (result) => {
        if (result.isConfirmed) {



          var result = await deleteCustomerByEmail(valuePCard);
          if (result) {
            Swal.fire(
              {

                icon: 'success',
                title: 'Success',
                showConfirmButton: false,
                timer: 1500
              })
            $(this).parent().remove();
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Message',
              text: 'Delete Fail.',

            })
          }



        } else if (
          /* Read more about handling dismissals below */
          result.dismiss === Swal.DismissReason.cancel
        ) {

        }
      })
    })

    $(".btnDelete").on("click", function () {
      var phoneValue = $(this).closest('tr').find('.phone').text();
      const swalWithBootstrapButtons = Swal.mixin({
        customClass: {
          confirmButton: 'btn btn-success',
          cancelButton: 'btn btn-danger mr-4'
        },
        buttonsStyling: false
      })
      swalWithBootstrapButtons.fire({
        title: 'Are you sure?',
        text: "Are you sure you want to delete!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'delete',
        cancelButtonText: 'cancel',
        reverseButtons: true
      }).then(async (result) => {
        if (result.isConfirmed) {



          var result = await deleteCustomerByPhone(phoneValue);
          if (result) {
            Swal.fire(
              {

                icon: 'success',
                title: 'Success',
                showConfirmButton: false,
                timer: 1500
              })
            var row = $(this).closest('tr');
            row.remove().draw();
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Message',
              text: 'Delete Fail.',

            })
          }



        } else if (
          /* Read more about handling dismissals below */
          result.dismiss === Swal.DismissReason.cancel
        ) {

        }
      })
    })
    async function getCustomerMailByEmail(email) {
      var customer;
      try {
        customer = await $.ajax({
          type: "GET",
          url: "/customer-mail/search/email?email=" + email,
          dataType: "json",
          success: function (response) {

          },
          error: function (jqXHR, textStatus, errorThrown) {
            return null
          }
        });
      } catch (error) {
        customer = null;
      }
      return customer;

    }
    $("#inputAddEmail").change(async function () {
      try {
        var emailCheck = await getCustomerMailByEmail($("#inputAddEmail").val());
        if (emailCheck) {
          var validator = $("#formAddEmail").validate();
          validator.showErrors({
            emailAddEmail: "Email already exists." // Thông báo lỗi trùng email
          });
        }
      } catch (error) {



        var validator = $("#formAddEmail").validate();
        validator.showErrors({
          emailAddEmail: "Email already exists." // Thông báo lỗi trùng email
        });

      }
    })
    $("#inputPhone").change(async function () {
      var phoneCheck = await getCustomerByPhoneAndId($("#inputPhone").val(), $("#inputId").val());
      if (phoneCheck) {
        var validator = $("#formUpdateCustomer").validate();
        validator.showErrors({
          phone: "Phone already exists." // Thông báo lỗi trùng email
        });
      }
    })
    function createObjectEmployee(id, fullName, phone, email, address, userName, password, role, avatar, status) {
      var object = {
        id: id,
        full_name: fullName,
        phone: phone,
        email: email,
        address: address,
        user_name: userName,
        pass: password,
        status: status,
        role: role === "Employee" ? 0 : 1,
        avatar: avatar
      }
      return object;
    }
    function createObjectCustomer(id, fullName, phone, address, status, takeNote) {
      var object = {
        id: id,
        employee_id: null,
        customer_name: fullName,
        phone: phone,
        address: address,
        take_note: takeNote,
        status: status,

      }
      return object;
    }
    $(".btnAdd").on("click", async function () {
      //load data on form
      var checkedId = []
      var checkedName = []
      $('input[type="checkbox"]:checked').each(function () {
        // Get the closest <tr> element
        var row = $(this).closest('tr');

        // Get the ID value from the hidden <td> element
        var phone = row.find('.id').text();
        var name = row.find('.fullName').text();
        // Add the ID to the array
        checkedId.push(phone);
        checkedName.push(name);
      });
      if (checkedId.length === 1) {
        toastr.info('Select the row you want to add mail.');
      } else {

        for (let index = 0; index < checkedId.length; index++) {
          $("#modal-addEmail").modal("show");
          const element = checkedId[index];
          const elementName = checkedName[index];
          console.log(element);
          if (element) {
            var option = $('<option>', {
              value: element, // Set the value attribute
              text: elementName // Set the text content
            });

            // Append the option element to the select element
            $('#addMailNameE').append(option);

            // await deleteCustomerByPhone(element);
            // $('input[type="checkbox"]:checked').each(function () {
            //   // Get the closest <tr> element
            //   var row = $(this).closest('tr');

            //   // Remove the row
            //   row.remove();

            // });
          } else {
            // Swal.fire({
            //   icon: 'error',
            //   title: 'Message',
            //   text: 'Delete Fail.',

            // })
          }

        }
      }
      // var emailValue = $(this).closest('tr').find('.email').text();
      // var phoneValue = $(this).closest('tr').find('.phone').text();
      // var fullNameValue = $(this).closest('tr').find('.fullName').text();

      // // $('#addMailNameE').append();
      // // var addressValue = $(this).closest('tr').find('.address').text();
      // // var roleValue = $(this).closest('tr').find('.role').text();
      // // var statusValue = $(this).closest('tr').find('.status').text();
      // var idValue = $(this).closest('tr').find('.id').text();
      // $("#inputAddId").val(idValue);
      // $("#inputAddFullName").val(fullNameValue);
      // $("#inputAddPhone").val(phoneValue);
      // $("#inputAddEmail").val("");

      // $("#inputEmail").val(emailValue);
      // $("#inputAddress").val(addressValue);
      // var employee = await getEmployeeByPhoneAndId(phoneValue, 2);

      // console.log(employee);
      // $("#role").val(roleValue === "employee" ? "Employee" : "Admin");
      // $("#status").val(statusValue === "active" ? "Active" : "Deactive");
      //$("#inputPhoneUpdate").val(phoneValue);
    })
    $(".btnDeleteAll").on("click", function () {
      var checkedPhones = [];

      // Find all the checked checkboxes and retrieve the corresponding ID
      $('input[type="checkbox"]:checked').each(function () {
        // Get the closest <tr> element
        var row = $(this).closest('tr');

        // Get the ID value from the hidden <td> element
        var phone = row.find('.phone').text();

        // Add the ID to the array
        checkedPhones.push(phone);
      });
      if (checkedPhones.length === 1) {
        toastr.info('Select the row you want to delete.');
      } else {
        console.log(checkedPhones);
        const swalWithBootstrapButtons = Swal.mixin({
          customClass: {
            confirmButton: 'btn btn-success',
            cancelButton: 'btn btn-danger mr-4'
          },
          buttonsStyling: false
        })
        swalWithBootstrapButtons.fire({
          title: 'Are you sure?',
          text: "Are you sure you want to delete!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'delete',
          cancelButtonText: 'cancel',
          reverseButtons: true
        }).then(async (result) => {
          if (result.isConfirmed) {
            var result = false;

            try {
              for (let index = 0; index < checkedPhones.length; index++) {
                const element = checkedPhones[index];
                if (element) {
                  await deleteCustomerByPhone(element);
                  $('input[type="checkbox"]:checked').each(function () {
                    // Get the closest <tr> element
                    var row = $(this).closest('tr');

                    // Remove the row
                    row.remove();

                  });
                } else {
                  Swal.fire({
                    icon: 'error',
                    title: 'Message',
                    text: 'Delete Fail.',

                  })
                }

              }

              result = true;
            } catch (error) {
              result = false;
            }

            if (result) {
              Swal.fire(
                {

                  icon: 'success',
                  title: 'Success',
                  showConfirmButton: false,
                  timer: 1500
                })

            } else {
              Swal.fire({
                icon: 'error',
                title: 'Message',
                text: 'Delete Fail.',

              })
            }



          } else if (
            /* Read more about handling dismissals below */
            result.dismiss === Swal.DismissReason.cancel
          ) {

          }
        })
      }
      // Log the array of checked IDs


    })
    $(".btnUpdate").on("click", async function () {
      //load data on form

      var phoneValue = $(this).closest('tr').find('.phone').text();
      var fullNameValue = $(this).closest('tr').find('.fullName').text();
      var addressValue = $(this).closest('tr').find('.address').text();
      var roleValue = $(this).closest('tr').find('.role').text();
      var statusValue = $(this).closest('tr').find('.status').text();
      var idValue = $(this).closest('tr').find('.id').text();
      var takeNoteValue = $(this).closest('tr').find('.takeNote').text();
      $("#inputId").val(idValue);
      $("#inputFullName").val(fullNameValue);
      $("#inputPhone").val(phoneValue);
      $("#inputTakeNote").val(takeNoteValue);
      $("#inputAddress").val(addressValue);
      // var employee = await getEmployeeByPhoneAndId(phoneValue, 2);

      // console.log(employee);
      $("#role").val(roleValue === "employee" ? "Employee" : "Admin");
      $("#status").val(statusValue === "active" ? "Active" : "Deactive");
      //$("#inputPhoneUpdate").val(phoneValue);
    })
    $("#updateEmployee").on("click", function () {
      $('#formUpdateCustomer').submit();
    })
    $("#addEmail").on("click", function () {
      $('#formAddEmail').submit();
    })
    async function createCustomerMail(dataCustomerMail) {

      var url = "/customer-mail/create";
      try {
        await $.ajax({
          url: url,
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify(dataCustomerMail),
          success: function (response) {
            return true;
          },
          error: function (xhr) {
            return false;
          }
        });
        return true;
      } catch (error) {
        return false;
      }

    }
    async function updateEmployee(data) {
      var url = "/employee/update";
      try {
        await $.ajax({
          url: url,
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify(data),
          success: function (response) {
            return true;
          },
          error: function (xhr) {
            return false;
          }
        });
        return true;
      } catch (error) {
        return false;
      }

    }
    async function updateCustomer(data) {
      var url = "/customer/update";
      try {
        await $.ajax({
          url: url,
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify(data),
          success: function (response) {
            return true;
          },
          error: function (xhr) {
            return false;
          }
        });
        return true;
      } catch (error) {
        return false;
      }

    }
    function createObjectCustomerMail(id, email) {
      var object = {
        customerId: { id: parseInt(id) },
        mail: email

      }
      return object;
    }
    async function getCustomerByPhone(phone) {
      var customer;
      try {
        customer = await $.ajax({
          type: "GET",
          url: "/customer/search/phone?phone=" + phone,
          dataType: "json",
          success: function (response) {

          },
          error: function (jqXHR, textStatus, errorThrown) {
            return null
          }
        });
      } catch (error) {
        customer = null;
      }
      return customer;

    }
    async function getCustomerByPhoneAndId(phone, id) {
      var customer;
      try {
        customer = await $.ajax({
          type: "GET",
          url: "/customer/search/phone-and-id?phone=" + phone + "&id=" + id,
          dataType: "json",
          success: function (response) {

          },
          error: function (jqXHR, textStatus, errorThrown) {
            return null
          }
        });
      } catch (error) {
        customer = null;
      }
      return customer;

    }
    $(function () {
      var savedData = localStorage.getItem('acc');
      if (savedData) {
        // Parse the data from string to its original format
        var parsedData = JSON.parse(savedData);
        //console.log(parsedData.image)
        $('#accImage').attr('src', parsedData.avatar);
        $("#accName").text(parsedData.full_name);
        // Use the retrieved data as needed

      } else {
        // Handle the case when no data is found in localStorage
        alert('Error');
      }
      $('#formAddEmail').submit(async function (event) {
        event.preventDefault();

        try {

          // alert("Form successful submitted!");
          //lay gia tri
          var fullName = $('#addMailNameE option:selected').text();
          // var phone = $("#inputAddPhone").val();
          var email = $("#inputAddEmail").val();

          var id = $('#addMailNameE').val();

          //kt trung
          var checkInput = false;
          var emailCheck = await getCustomerMailByEmail($("#inputAddEmail").val());
          if (!emailCheck) {
            checkInput = true
          } else {
            var validator = $(this).validate();
            validator.showErrors({
              emailAddEmail: "Email already exists." // Thông báo lỗi trùng email
            });
          }

          if (checkInput && fullName && email) {
            //tao employee
            var objectCustomerMail = createObjectCustomerMail(id, email);

            var stateCreateCustomerMail = await createCustomerMail(objectCustomerMail);
            // console.log(objectCustomerMail);
            $('#addMailNameE option:selected').remove();
            if (stateCreateCustomerMail) {
              Swal.fire(
                {

                  icon: 'success',
                  title: 'Success',
                  showConfirmButton: false,
                  timer: 1500
                });
              //

              //
              //tieeps tucj submit
              // $(this).unbind("submit").submit();
              // setTimeout(function () {
              //   location.reload();
              // }, 1600);

            } else {
              Swal.fire({
                icon: 'error',
                title: 'Chỉnh sửa thông tin không thành công',
                text: 'Chỉnh sửa thông tin không thành công.',

              })
            }


          } else {
            //ko tao employee
          }
        } catch (error) {
          alert(error)
        }
      });
      $('#modal-addEmail').on('hidden.bs.modal', function () {
        // Handle the hide event here

        location.reload();

      });
      $('#formAddEmail').validate({
        rules: {
          emailAddEmail: {
            required: true,
            email: true,
          },

          fullNameAddEmail: {
            required: true,

          },
          phoneAddEmail: {
            required: true,
            minlength: 10
          },


        },
        messages: {
          email: {
            required: "Please enter a email address",
            email: "Please enter a valid email address"
          },
          fullName: {
            required: "Please enter full name",

          },
          phone: {
            required: "Please enter a phone",
            minlength: "Please enter a valid phone"
          },



        },
        errorElement: 'span',
        errorPlacement: function (error, element) {
          error.addClass('invalid-feedback');
          element.closest('.input').append(error);
        },
        highlight: function (element, errorClass, validClass) {
          $(element).addClass('is-invalid');
        },
        unhighlight: function (element, errorClass, validClass) {
          $(element).removeClass('is-invalid');
        }
      });
      $('#formUpdateCustomer').submit(async function (event) {
        event.preventDefault();
        try {

          // alert("Form successful submitted!");
          //lay gia tri
          var fullName = $("#inputFullName").val();
          var phone = $("#inputPhone").val();

          var address = $("#inputAddress").val();
          var id = $("#inputId").val();
          var status = $("#status").val() === "Active" ? "active" : "deactive";
          var takeNote = $("#inputTakeNote").val();
          //kt trung
          var checkInput = false;
          var cusApi = await getCustomerByPhoneAndId(phone, id);
          var phoneRegex = /^\d{10}$/;
          if (cusApi || !phoneRegex.test(phone)) {
            var checkInput = false;
            var validator = $("#formUpdateCustomer").validate();
            validator.showErrors({
              phone: "Phone already exists." // Thông báo lỗi trùng email
            });
          } else {
            checkInput = true;
          }

          if (checkInput && fullName && phone && address) {
            //tao employee
            var object = createObjectCustomer(id, fullName, phone, address, status, takeNote);
            var stateCreateCustomer = await updateCustomer(object);
            if (stateCreateCustomer) {
              Swal.fire(
                {

                  icon: 'success',
                  title: 'Success',
                  showConfirmButton: false,
                  timer: 1500
                });
              //

              //
              //tieeps tucj submit
              // $(this).unbind("submit").submit();
              setTimeout(function () {
                location.reload();
              }, 1600);

            } else {
              Swal.fire({
                icon: 'error',
                title: 'Chỉnh sửa thông tin không thành công',
                text: 'Chỉnh sửa thông tin không thành công.',

              })
            }


          } else {
            //ko tao employee
          }
        } catch (error) {
          alert(error)
        }
      })

      $('#formUpdateCustomer').validate({
        rules: {
          email: {
            required: true,
            email: true,
          },

          fullName: {
            required: true,

          },
          phone: {
            required: true,
            minlength: 10,
            maxlength: 10
          },
          address: {
            required: true,

          },

        },
        messages: {
          email: {
            required: "Please enter a email address",
            email: "Please enter a valid email address"
          },
          fullName: {
            required: "Please enter full name",

          },
          phone: {
            required: "Please enter a phone",
            minlength: "Please enter a valid phone",
            maxlength: "Please enter a valid phone"
          },
          address: {
            required: "Please enter a address",

          },


        },
        errorElement: 'span',
        errorPlacement: function (error, element) {
          error.addClass('invalid-feedback');
          element.closest('.input').append(error);
        },
        highlight: function (element, errorClass, validClass) {
          $(element).addClass('is-invalid');
        },
        unhighlight: function (element, errorClass, validClass) {
          $(element).removeClass('is-invalid');
        }
      });
    });
  </script>
</body>

</html>